#//==============================================================================//#
"""
vector_search.py
BGE-M3 벡터 검색 도구

last_updated: 2025.01.16
"""
#//==============================================================================//#

import sys
import os

current_file = os.path.abspath(__file__)
analytics_dir = os.path.dirname(os.path.dirname(os.path.dirname(current_file)))

if analytics_dir not in sys.path:
    sys.path.insert(0, analytics_dir)

import pandas as pd
import psycopg2
from typing import Dict, List, Optional
from sentence_transformers import SentenceTransformer

#//==============================================================================//#
# Vector Search Tool
#//==============================================================================//#

class VectorSearchTool:
    """
    BGE-M3 임베딩 기반 벡터 검색
    """
    
    def __init__(self, db_config: Dict):
        """
        초기화
        
        Args:
            db_config: DB 설정
        """
        self.db_config = db_config
        self.conn = None
        
        # BGE-M3 모델 로드
        self.model = SentenceTransformer('BAAI/bge-m3')
    
    def connect(self):
        """DB 연결"""
        if not self.conn or self.conn.closed:
            self.conn = psycopg2.connect(**self.db_config, client_encoding='utf8')
    
    def search(
        self,
        query: str,
        top_k: int = 30,
        filters: Optional[Dict] = None
    ) -> pd.DataFrame:
        """
        의미 기반 벡터 검색
        
        Args:
            query: 검색 쿼리
            top_k: 반환할 개수
            filters: 필터 조건 {brand, channel, category, min_rating, date_from, date_to}
        
        Returns:
            검색 결과 DataFrame
        """
        
        self.connect()
        
        # BGE-M3로 쿼리 임베딩 (1024차원)
        query_embedding = self.model.encode(query, normalize_embeddings=True)
        query_embedding_str = str(query_embedding.tolist())
        
        # SQL 구성
        sql = """
        SELECT 
            review_id,
            product_name,
            brand,
            channel,
            category,
            rating,
            review_date,
            review_text,
            reviewer_skin_features,
            1 - (embedding <=> %s::vector) as similarity
        FROM reviews
        WHERE LENGTH(review_text) > 10
        """
        
        params = [query_embedding_str]
        
        # 필터 적용
        if filters:
            if filters.get('brand'):
                sql += " AND brand = %s"
                params.append(filters['brand'])
            
            if filters.get('channel'):
                sql += " AND channel = %s"
                params.append(filters['channel'])
            
            if filters.get('category'):
                sql += " AND category = %s"
                params.append(filters['category'])
            
            if filters.get('min_rating'):
                sql += " AND rating >= %s"
                params.append(filters['min_rating'])
            
            if filters.get('date_from'):
                sql += " AND review_date >= %s"
                params.append(filters['date_from'])
            
            if filters.get('date_to'):
                sql += " AND review_date <= %s"
                params.append(filters['date_to'])
        
        sql += f" ORDER BY embedding <=> %s::vector LIMIT %s"
        params.extend([query_embedding_str, top_k])
        
        # 실행
        with self.conn.cursor() as cur:
            cur.execute(sql, params)
            columns = [desc[0] for desc in cur.description]
            data = cur.fetchall()
        
        df = pd.DataFrame(data, columns=columns)
        
        return df
    
    def close(self):
        """연결 종료"""
        if self.conn and not self.conn.closed:
            self.conn.close()