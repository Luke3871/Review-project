#//==============================================================================//#
"""
map_prompt.py
Map 단계 프롬프트 생성 for V4 ReAct Agent

구조화되고 상세한 청크별 요약 프롬프트
당신의 전처리 프롬프트 스타일 차용: 명확한 형식 + 예시
"""
#//==============================================================================//#

from .domain_guide import get_domain_guide

def create_map_prompt(reviews, query, chunk_num, category=None):
    """
    Map 단계 프롬프트 생성

    Args:
        reviews: 리뷰 리스트
        query: 사용자 질문
        chunk_num: 청크 번호
        category: 제품 카테고리

    Returns:
        Map 프롬프트 문자열
    """

    reviews_text = "\n".join([
        f"[{i+1}] {r[:300]}"
        for i, r in enumerate(reviews[:20])
    ])

    domain_guide = get_domain_guide(category)

    prompt = f"""당신은 화장품 리뷰 분석 전문가입니다.
다음 {len(reviews)}개 리뷰를 제조사 관점에서 분석하세요.

[사용자 질문]
{query}

[리뷰 원문] (그룹 {chunk_num})
{reviews_text}

{domain_guide}

[분석 원칙]
1. **질문 중심**: "{query}"에 답하는 데 필요한 정보만 추출
2. **정량화 필수**: 반드시 빈도/비율 표시 (예: "15/20명")
3. **구체적 표현**: 원문의 핵심 표현을 따옴표로 인용
4. **패턴 발견**: 반복되는 의견, Trade-off, 조건부 평가
5. **제조사 관점**: 배송/포장/판매자 관련 무시
6. **리뷰 기반**: 추측 금지, 언급된 내용만

[출력 형식]

다음 형식으로 **반드시** 작성하세요:

**속성별 평가** (언급된 속성만)
- [속성명]: 언급 N/{len(reviews)} | 긍정 X, 부정 Y | 표현: "원문 인용1", "원문 인용2"

예시:
- 보습력: 언급 15/20 | 긍정 14, 부정 1 | 표현: "하루종일 촉촉", "수분감 오래감"
- 끈적임: 언급 8/20 | 부정 8 | 표현: "끈적여서 답답", "여름엔 무거움"

**불만사항** (있다면)
- [유형]: N건 (구체적 내용)

예시:
- 용기: 3건 (펌프 뻑뻑 2건, 뚜껑 안 열림 1건)
- 향: 2건 (너무 강함 1건, 인공적 1건)

**구매동기** (있다면)
- [유형]: N건 (인물/채널 기록)

예시:
- 인플루언서: 5건 (자은우 2건, 기타 3건)
- 재구매: 3건

**조건부 패턴** (발견되면)
- [조건]: 평가 내용

예시:
- 지성 피부: 8/10명 끈적임 불만
- 여름 사용: 5/7명 답답하다고 언급
- 민감성 피부: 4/4명 자극 없다고 만족

**종합** (3-4문장)
[정량적 수치를 반드시 포함한 핵심 요약]

예시:
이 그룹에서 보습력 만족도는 높으나(14/15명 긍정), 끈적임이 주요 불만(8/20명).
지성 피부 사용자의 80%(8/10명)가 끈적임 문제 제기.
인플루언서 추천으로 구매한 경우 5건 발견(자은우 2건).

---

[실제 분석 예시]

질문: "토리든 보습력 어때?"
리뷰 샘플:
[1] 보습력 정말 좋아요. 하루종일 촉촉해요.
[2] 수분감은 좋은데 좀 끈적여요.
[3] 민감성 피부인데 자극 없고 보습력 좋습니다.
[4] 여름엔 너무 무거워요. 겨울용인 듯.
[5] 자은우 추천으로 샀는데 보습 정말 좋네요.
...

출력:

**속성별 평가**
- 보습력: 언급 18/20 | 긍정 17, 부정 1 | 표현: "하루종일 촉촉", "수분감 오래감", "보습 정말 좋음"
- 끈적임: 언급 8/20 | 부정 8 | 표현: "좀 끈적여요", "여름엔 무거워", "답답함"

**불만사항**
- 제형: 8건 (끈적임으로 인한 답답함)

**구매동기**
- 인플루언서: 5건 (자은우 2건, 기타 3건)
- 재구매: 2건

**조건부 패턴**
- 민감성 피부: 5/5명 자극 없다고 만족
- 지성 피부: 6/8명 끈적임 불만
- 여름 사용: 4/5명 무겁다고 평가

**종합**
보습력에 대한 만족도는 매우 높음(17/18명 긍정, 94%).
하지만 끈적임이 주요 약점(8/20명, 40% 언급)으로, 특히 지성 피부(6/8명)와 여름 사용 시(4/5명) 부정적.
민감성 피부 사용자는 자극 없이 만족(5/5명, 100%).
인플루언서 마케팅 효과 확인(5건, 자은우 2건).

---

이제 위 형식을 따라 그룹 {chunk_num}의 {len(reviews)}개 리뷰를 분석하세요.
"""

    return prompt
