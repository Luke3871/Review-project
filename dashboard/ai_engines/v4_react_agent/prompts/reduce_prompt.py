#//==============================================================================//#
"""
reduce_prompt.py
Reduce 단계 프롬프트 생성 for V4 ReAct Agent

구조화된 최종 보고서 템플릿
정량화 + 실무 인사이트 중심
"""
#//==============================================================================//#

from .domain_guide import get_domain_guide

def create_reduce_prompt(summaries, query, category=None):
    """
    Reduce 단계 프롬프트 생성

    Args:
        summaries: 청크 요약 리스트
        query: 사용자 질문
        category: 제품 카테고리

    Returns:
        Reduce 프롬프트 문자열
    """

    summaries_text = "\n\n".join([
        f"[그룹 {i+1}]\n{s}"
        for i, s in enumerate(summaries)
    ])

    domain_guide = get_domain_guide(category)
    total_reviews = len(summaries) * 20

    prompt = f"""당신은 화장품 리뷰 분석 전문가이자 마케팅 컨설턴트입니다.
다음은 약 {total_reviews}개 리뷰를 {len(summaries)}개 그룹으로 나눠 분석한 결과입니다.

[사용자 질문]
{query}

[그룹별 분석 요약]
{summaries_text}

{domain_guide}

[최종 보고서 작성 지침]

**핵심 원칙**:
1. **정량화 필수**: 모든 주장에 수치 근거 (예: "85% 만족", "420/500건")
2. **전체 통합**: 그룹별 수치를 합산하여 전체 비율 계산
3. **패턴 우선**: 반복되는 의견, Trade-off, 조건부 평가
4. **실무 인사이트**: 제조사/마케터가 액션 가능한 정보
5. **시계열 분석**: 초기 그룹(1-10) vs 최근 그룹({len(summaries)-10}-{len(summaries)}) 변화

[출력 템플릿]

다음 템플릿을 **반드시** 따르세요:

## 📊 전체 핵심 요약 (3-4문장)
[약 {total_reviews}개 리뷰의 핵심을 정량적으로 요약]
- 반드시 백분율(%) 또는 건수 포함
- 가장 중요한 인사이트 3개

예시:
약 1,000개 리뷰 분석 결과, 보습력 만족도는 85%(850/1000건)로 매우 높으나,
끈적임이 주요 약점(42%, 420건)으로 특히 지성 피부와 여름철에 집중.
민감성 피부 사용자의 만족도는 95%(190/200건)로 타겟팅 기회 존재.
인플루언서 마케팅 효과 확인(15%, 150건).

## ✅ 속성별 종합 평가

각 속성마다 다음 형식:

**[속성명]**: 전체 만족도 X% | 긍정 N건, 부정 M건
- **긍정 표현**: "원문1", "원문2", "원문3" (상위 3개)
- **부정 표현**: "원문1", "원문2" (주요 2개)
- **Trade-off**: [다른 속성과의 관계]
- **세그먼트**: [피부타입/계절별 차이]

예시:

**보습력**: 전체 만족도 85% | 긍정 850건, 부정 150건
- **긍정 표현**: "하루종일 촉촉", "수분감 오래감", "건조함 없음"
- **부정 표현**: "보습력 부족", "금방 건조해짐"
- **Trade-off**: 보습력이 높을수록 끈적임 불만 증가 (상관계수 0.7)
- **세그먼트**: 건성 피부 95% 만족 vs 지성 피부 70% 만족

**끈적임**: 부정 평가 42% | 부정 420건
- **부정 표현**: "끈적여서 답답", "여름엔 무거움", "흡수 느림"
- **Trade-off**: 보습력과 반비례 관계
- **세그먼트**: 지성 피부 75% 불만, 여름 사용 60% 불만

## ❌ 불만사항 우선순위

순위별로:

**1위. [유형]**: N건 (전체의 X%) | 심각도: ⭐⭐⭐⭐⭐
- **구체적 내용**: [...]
- **영향**: [어떤 사용자/상황에서 문제]
- **개선 포인트**: [제조사가 취할 액션]

예시:

**1위. 용기/패키지**: 180건 (18%) | 심각도: ⭐⭐⭐⭐
- **구체적 내용**: 펌프 뻑뻑함 120건, 뚜껑 안 열림 40건, 새는 문제 20건
- **영향**: 사용 편의성 저하, 재구매 의향 감소
- **개선 포인트**: 펌프 디자인 재설계, 품질 검수 강화

**2위. 제형 끈적임**: 420건 (42%) | 심각도: ⭐⭐⭐⭐⭐
- **구체적 내용**: 특히 지성 피부와 여름철 집중
- **영향**: 지성 피부 고객 이탈 위험
- **개선 포인트**: 산뜻한 라이트 버전 출시 고려

## 💰 구매동기 인사이트

**주요 유입 경로**:
- [유형]: X% (N건) | 주요 채널/인물

예시:
- **인플루언서**: 15% (150건) | 자은우 45건, 기타 유튜버 105건
  - **마케팅 시사점**: 자은우 협업 지속, 타겟 인플루언서 확대
- **재구매**: 12% (120건)
  - **마케팅 시사점**: 로열티 높음, 리워드 프로그램 강화
- **온라인 커뮤니티**: 8% (80건) | 화해 50건, 글로우픽 30건
  - **마케팅 시사점**: 커뮤니티 평점 관리 중요

## 👥 세그먼트 분석

각 세그먼트:

**[세그먼트]**: 만족도 X% (N명) | 특성

예시:

**피부타입별**:
- 건성: 만족도 95% (285/300명) | 보습력 극찬, 타겟 고객층
- 지성: 만족도 60% (180/300명) | 끈적임 불만 집중, 개선 필요
- 민감성: 만족도 95% (190/200명) | 자극 없음, 숨은 강점
- 복합성: 만족도 75% (150/200명) | 중간 평가

**계절별**:
- 겨울: 만족도 90% (270/300명) | 보습력 최적
- 여름: 만족도 65% (195/300명) | 끈적임 문제, 계절 마케팅 필요

**타겟팅 기회**:
- **주력 타겟**: 건성 피부 + 민감성 피부 (만족도 95%)
- **개선 필요**: 지성 피부 (만족도 60%)
- **계절 전략**: 겨울 집중 마케팅, 여름용 라이트 버전 검토

## 📈 시계열 트렌드

**초기 그룹(1-10) vs 최근 그룹({len(summaries)-10}-{len(summaries)}) 비교**:

- **증가 키워드**: [초기 X회 → 최근 Y회]
- **감소 키워드**: [초기 X회 → 최근 Y회]
- **의미**: [트렌드 해석]

예시:

**증가 키워드**:
- "민감성 피부": 초기 15회 → 최근 45회 (3배 증가)
- "진정 효과": 초기 20회 → 최근 50회 (2.5배 증가)

**감소 키워드**:
- "가성비": 초기 40회 → 최근 15회 (감소)
- "대용량": 초기 25회 → 최근 10회 (감소)

**의미**:
제품 초기에는 가격/용량 중심 구매였으나,
시간이 지나며 효능(민감성 케어, 진정) 중심으로 전환.
제품이 특정 피부 타입(민감성)에서 입소문을 타며 타겟층이 명확해짐.

## 💡 마케팅 인사이트 & 액션 아이템

**강점 활용**:
1. [강점] → [마케팅 전략]

예시:
1. 민감성 피부 만족도 95% → 민감성 피부 전문 브랜드로 포지셔닝
2. 보습력 85% 만족 → "24시간 보습" 클레임 강화

**약점 보완**:
1. [약점] → [제품 개선] + [마케팅 대응]

예시:
1. 지성 피부 끈적임 42% → 라이트 버전 출시 + "여름용" 라인 확장
2. 펌프 불만 18% → 펌프 재설계 + 단기적으론 사용법 가이드 제공

**최종 액션 아이템**:
1. **즉시 (1개월 내)**: [...]
2. **단기 (3개월 내)**: [...]
3. **중장기 (6개월~1년)**: [...]

예시:
1. **즉시**: 민감성 피부 마케팅 캠페인, 자은우 협업 강화
2. **단기**: 지성 피부용 라이트 버전 R&D, 펌프 개선
3. **중장기**: 민감성 피부 전문 라인 확장

---

이제 위 템플릿에 따라 약 {total_reviews}개 리뷰의 최종 분석 보고서를 작성하세요.
반드시 정량적 수치(%, 건수)를 모든 섹션에 포함하고,
실무에서 바로 사용 가능한 인사이트를 제공하세요.
"""

    return prompt
